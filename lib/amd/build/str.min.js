define(["jquery","core/ajax","core/localstorage"],function(a,b,c){function d(a){return"undefined"!=typeof M.str[a.component]&&"undefined"!=typeof M.str[a.component][a.key]}function e(b){return a.when.apply(a.when,b.map(function(a){var b=g(a);return h[b]})).then(function(){return Array.prototype.slice.call(arguments)})}function f(a,b){"undefined"==typeof M.str[a.component]&&(M.str[a.component]={}),M.str[a.component][a.key]=b}function g(a){return"core_str/"+a.key+"/"+a.component+"/"+a.lang}var h={};return{get_string:function(a,b,c,d){var e=this.get_strings([{key:a,component:b,param:c,lang:d}]);return e.then(function(a){return a[0]})},get_strings:function(i){var j,k,l=0,m=[];for(l=0;l<i.length;l++)if(j=i[l],"undefined"==typeof j.lang&&(j.lang=a("html").attr("lang").replace("-","_")),k=g(j),"undefined"==typeof h[k]){var n=a.Deferred();if(h[k]=n,!d(j)){var o=c.get(k);o&&f(j,o)}d(j)?n.resolve(M.util.get_string(j.key,j.component,j.param)):m.push(l)}if(m.length<=0)return e(i);var p=[];for(l=0;l<m.length;l++)j=i[m[l]],p.push({methodname:"core_get_string",args:{stringid:j.key,component:j.component,lang:j.lang,stringparams:[]}});var q=b.call(p,!0,!1);return a.when.apply(null,q).then(function(){for(l=0;l<arguments.length;l++){var a=i[m[l]],b=arguments[l],d=g(a);f(a,b),c.set(d,b),h[d].resolve(b)}return e(i)})}}});
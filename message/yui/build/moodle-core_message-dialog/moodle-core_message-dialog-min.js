YUI.add("moodle-core_message-dialog",function(e,t){var n={PREFIX:"core_message_dialog",TITLE:"dialog-title"},r={TITLE:".dialog-title"},i=function(){i.superclass.constructor.apply(this,arguments)};e.namespace("M.core_message").Dialog=e.extend(i,M.core.dialogue,{_bb:null,_ioFetch:null,_lastUserId:null,_messageTemplate:null,initializer:function(){e.delegate("click",function(e){var t=e.currentTarget,n=t.getData("core_message-dialog-fullname"),r=parseInt(t.getData("core_message-dialog-userid"),10);if(!n||!r)return;this.set("fullname",n),this.set("userid",r),this.display()},"body","[data-core_message-dialog]",this),tpl=e.Handlebars.compile('<div class="wrapper"><div class="messages-area"><div class="loading hidden" style="text-align: center;"><img alt="" role="presentation" src="{{{loadingIcon}}}"></div><div class="messages"></div></div><div class="form"><input type="text" id="new-message"><input type="submit" value="Send" id="send-message"></div></div>'),content=e.Node.create(tpl({loadingIcon:M.util.image_url("i/loading","moodle")})),this.setStdModContent(e.WidgetStdMod.BODY,content,e.WidgetStdMod.REPLACE),this.getStdModNode(e.WidgetStdMod.HEADER).prepend(e.Node.create('<h1 class="'+n.TITLE+'"></h1>')),this.get("boundingBox").one(".moodle-dialogue-wrap").addClass("moodle-dialogue-content")},display:function(){this._lastUserId!==this.get("userid")&&(this.reset(),this.loadMessages()),this.getBB().one(r.TITLE).setHTML(this.get("fullname")),this._lastUserId=this.get("userid"),this.show()},displayMessages:function(t){var n,r;this._messageTemplate||(this._messageTemplate=e.Handlebars.compile('<div class="message {{mine}}"><div class="content">{{{content}}}</div><div class="time">{{time}}</div></div>')),this.getBB().one(".loading").addClass("hidden"),messagesarea=this.getBB().one(".messages-area"),n=this.getBB().one(".messages"),e.each(t,function(t,r){var i=e.Node.create(this._messageTemplate({mine:parseInt(t.useridfrom,10)===this.get("userid")?"mine":"",content:t.text,time:e.Date.format(e.Date.parse(t.timecreated*1e3),{format:"%a, %d %b %y %r"})}));n.append(i)},this),messagesarea.set("scrollTop",messagesarea.get("scrollHeight")),this.centerDialogue()},fetchMessages:function(t,n){this._ioFetch&&this._ioFetch.isInProgress()&&this._ioFetch.abort(),this._ioFetch=e.io(this.get("url"),{method:"GET",data:build_querystring({sesskey:M.cfg.sesskey,action:"getmessages",userid:this.get("userid")}),on:{success:function(r,i){var s=null,o=!1;try{s=e.JSON.parse(i.responseText),s.error&&(o=!0)}catch(u){o=!0}if(o){n.apply(this,[r,i,s]);return}t.apply(this,[r,i,s])},failure:n},context:this})},getBB:function(){return this._bb||(this._bb=this.get("boundingBox")),this._bb},loadMessages:function(){var e,t;e=function(e,t,n){this.displayMessages(n)},t=function(e,t,n){},this.fetchMessages(e,t)},reset:function(){this.getBB().one(".loading").removeClass("hidden"),this.getBB().one(".messages").empty()}},{NAME:"core_message_dialog",CSS_PREFIX:n.PREFIX,ATTRS:{fullname:{validator:e.Lang.isString,value:""},url:{validator:e.Lang.isString,valueFn:function(){return M.cfg.wwwroot+"/message/ajax.php"}},userid:{value:0}}}),e.Base.modifyAttrs(e.namespace("M.core_message.Dialog"),{extraClasses:{value:["core_message_dialog"]},focusOnPreviousTargetAfterHide:{value:!0},width:{value:"500px"},visible:{value:!1},modal:{value:!0},draggable:{value:!0}}),e.namespace("M.core_message.Dialog").init=function(e){return new i(e)}},"@VERSION@",{requires:["datatype-date","escape","handlebars","io-base","json-parse","moodle-core-notification-dialogue"]});

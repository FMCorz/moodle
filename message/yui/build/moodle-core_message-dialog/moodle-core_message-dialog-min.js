YUI.add("moodle-core_message-dialog",function(e,t){var n={CANNOTSEND:"message-cannot-send",FROMME:"message-from-me",ISFLOATING:"fixed-dialog",PREFIX:"core_message_dialog",TITLE:"dialog-title",WRAPPER:"core_message_dialog-wrapper"},r={TITLE:".dialog-title"},i=function(){i.superclass.constructor.apply(this,arguments)};e.namespace("M.core_message").Dialog=e.extend(i,M.core.dialogue,{_bb:null,_ioFetch:null,_lastDate:null,_loaded:!1,_messageTemplate:null,_sendLocked:!1,initializer:function(){tpl=e.Handlebars.compile('<div class="{{CSS.WRAPPER}}"><div class="messages-area"><div class="loading hidden" style="text-align: center;"><img alt="" role="presentation" src="{{{loadingIcon}}}"></div><div class="messages clearfix"></div><div class="message-sending hidden" aria-live="polite" style="text-align: right;"><img alt="" role="presentation" src="{{{smallLoadingIcon}}}"> Sending message...</div></div><div class="message-send-form"><form><div contenteditable="true" class="message-input"></div><input type="submit" value="Send" class="message-send"></form></div></div>'),content=e.Node.create(tpl({cannotSend:!this.get("sendAllowed"),CSS:n,loadingIcon:M.util.image_url("i/loading","moodle"),smallLoadingIcon:M.util.image_url("i/loading_small","moodle")})),this.setStdModContent(e.WidgetStdMod.BODY,content,e.WidgetStdMod.REPLACE),this.getStdModNode(e.WidgetStdMod.HEADER).prepend(e.Node.create('<h1 class="'+n.TITLE+'"></h1>')),this.getBB().one(".moodle-dialogue-wrap").addClass("moodle-dialogue-content"),this._setEvents()},addDate:function(t){var n=this.getBB().one(".messages");n.append(e.Node.create('<div class="message-date"><span>'+t+"</span></div>"))},addMessage:function(t){var r,i;return this._messageTemplate||(this._messageTemplate=e.Handlebars.compile('<div class="message {{fromMe}}"><div class="message-content">{{{content}}}</div><div class="message-time">{{time}}</div></div>')),r=this.getBB().one(".messages"),i=e.Node.create(this._messageTemplate({fromMe:parseInt(t.useridfrom,10)!==this.get("userid")?n.FROMME:"",content:t.text,time:t.time})),r.append(i),i},displayMessages:function(t){this.getBB().one(".loading").addClass("hidden"),e.each(t,function(e){this._lastDate!=e.date&&(this.addDate(e.date),this._lastDate=e.date),this.addMessage(e)},this),this.scrollToBottom()},fetchMessages:function(t,n){this._ioFetch&&this._ioFetch.isInProgress()&&this._ioFetch.abort(),this._ioFetch=e.io(this.get("url"),{method:"GET",data:build_querystring({sesskey:M.cfg.sesskey,action:"getmessages",userid:this.get("userid")}),on:{start:function(){this.setLockSend(!0)},success:function(r,i){var s=null,o=!1;try{s=e.JSON.parse(i.responseText),s.error&&(o=!0)}catch(u){o=!0}if(o){n.apply(this,[r,i]);return}t.apply(this,[r,i,s])},failure:n,complete:function(){this.setLockSend(!1)}},context:this})},hide:function(){return this.get("manager").notifyHide(this),i.superclass.hide.apply(this,arguments)},getBB:function(){return this._bb||(this._bb=this.get("boundingBox")),this._bb},loadMessages:function(){var e,t;e=function(e,t,n){this.displayMessages(n)},t=function(){},this.fetchMessages(e,t)},positionAdvised:function(e,t){console.log(e,t),this.set("position",[e,t]),this.updatePosition()},scrollToBottom:function(){var e=this.getBB().one(".messages-area");e.set("scrollTop",e.get("scrollHeight"))},sendMessage:function(t){var n;if(!t)return;if(t.replace(" ","").replace("&nbsp;","").trim().length<1)return;if(this._sendLocked||!this.get("sendAllowed"))return;this._ioSend=e.io(this.get("url"),{method:"POST",data:build_querystring({sesskey:M.cfg.sesskey,action:"sendmessage",userid:this.get("userid"),message:t}),on:{start:function(){this.getBB().one(".message-sending").removeClass("hidden"),this.scrollToBottom()},success:function(t,n){var r=null,i=!1;try{r=e.JSON.parse(n.responseText);if(r.error||!r.id)i=!0}catch(s){i=!0}if(i){failure.apply(this,[t,n]);return}this.addMessage(r),this.getBB().one(".message-input").setHTML(""),this.scrollToBottom()},failure:function(){},complete:function(){this.getBB().one(".message-sending").addClass("hidden")}},context:this})},setLockSend:function(e){var t=this.getBB().one(".message-send"),n=this.getBB().one(".message-input");e?(this._sendLocked=!0,t.set("disabled",!0),n.set("disabled",!0)):(this._sendLocked=!1,t.set("disabled",!1),n.set("disabled",!1))},show:function(){this._loaded||(this.getBB().one(".loading").removeClass("hidden"),this.loadMessages(),this.getBB().one(r.TITLE).setHTML(this.get("fullname"))),this._loaded=!0,i.superclass.show.apply(this,arguments),this.getBB().set("tabIndex","0").focus()},updatePosition:function(){if(this.shouldResizeFullscreen()||!this.get("position")){this.getBB().removeClass(n.ISFLOATING);return}this.getBB().addClass(n.ISFLOATING),this.getBB().setStyles({right:this.get("position")[0],bottom:this.get("position")[1],left:"",top:""})},_setEvents:function(){this.get("sendAllowed")&&(this.getBB().one(".message-send-form form").on("submit",function(e){var t=this.getBB().one(".message-input").get("value");this.sendMessage(t),e.preventDefault()},this),this.getBB().one(".message-input").on("key",function(e){if(e.shiftKey||e.altKey||e.metaKey||e.ctrlKey)return;this.sendMessage(e.currentTarget.getHTML()),e.preventDefault()},"down:enter",this))}},{NAME:"core_message_dialog",CSS_PREFIX:n.PREFIX,ATTRS:{sendAllowed:{validator:e.Lang.isBoolean,value:!1},fullname:{validator:e.Lang.isString,value:""},manager:{value:null},position:{value:[]},url:{validator:e.Lang.isString,valueFn:function(){return M.cfg.wwwroot+"/message/ajax.php"}},userid:{value:0}}}),e.Base.modifyAttrs(e.namespace("M.core_message.Dialog"),{extraClasses:{valueFn:function(){var e=["core_message_dialog"];return this.get("sendAllowed")||e.push(n.CANNOTSEND),e}},focusOnPreviousTargetAfterHide:{value:!0},width:{value:"220px"},visible:{value:!1},modal:{value:!1},draggable:{value:!1},center:{value:!1}});var s=function(){s.superclass.constructor.apply(this,arguments)};e.namespace("M.core_message").Manager=e.extend(s,e.Base,{_dialogs:{}
,_slots:[],initializer:function(){e.delegate("click",function(e){var t=e.currentTarget,n=t.getData("core_message-dialog-fullname"),r=null,i=parseInt(t.getData("core_message-dialog-userid"),10);if(!n||!i)return;r=this.getDialog(i,n);if(!r)return;e.preventDefault(),r.get("visible")?(r.hide(e),this.releaseSlot(r),this.notifyPositions()):(this.assignSlot(r),r.show(e),this.notifyPositions())},"body","[data-core_message-dialog]",this)},assignSlot:function(t){var n=e.Array.indexOf(this._slots,t);n<0&&this._slots.push(t)},getDialog:function(e,t){if(!this._dialogs[e]){var n=new i({manager:this,userid:e,fullname:t,sendAllowed:this.get("canSend")});this._dialogs[e]=n}return this._dialogs[e]},getSlotPosition:function(e){return e*220+20+e*10},notifyPositions:function(){var t=this;e.each(this._slots,function(e,n){e.positionAdvised(t.getSlotPosition(n),0)},this)},notifyHide:function(e){this.releaseSlot(e),this.notifyPositions()},releaseSlot:function(t){var n=e.Array.indexOf(this._slots,t),r;if(n<0)return;this._slots.splice(n,1)}},{ATTRS:{canSend:{validator:e.Lang.isBoolean,value:!1}}}),e.namespace("M.core_message.Dialog").init=function(e){return new s(e)}},"@VERSION@",{requires:["escape","handlebars","io-base","json-parse","moodle-core-notification-dialogue"]});

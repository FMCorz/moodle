define(["jquery","core/notification","core/ajax","core/templates","tool_lp/dialogue","core/str","tool_lp/tree"],function(a,b,c,d,e,f,g){return{frameworks:null,popup:null,selectedCompetency:0,requests:[],pagerender:null,pageregion:null,addCompetencyCallback:null,init:function(){var a=c.call([{methodname:"tool_lp_list_competency_frameworks",args:{filters:{},sort:"sortorder"}}]);return a[0].done(function(a){this.frameworks=a}.bind(this)).fail(b.exception),a[0]},setAddCompetencyRequests:function(a,b,c,d){this.requests=a,this.pagerender=b,this.pageregion=c,this.addCompetencyCallback=d},applyFilter:function(c){c.preventDefault();var e=a('[data-region="filtercompetencies"] input'),f=e.val(),g=a('[data-action="chooseframework"]'),h=g.val();this.searchCompetencies().done(function(c){var e=0,g=this.frameworks[0];for(e=0;e<this.frameworks.length;e++)this.frameworks[e].id==h?(g=this.frameworks[e],g.selected=!0):this.frameworks[e].selected=!1;g.selected=!0;var i={framework:g,frameworks:this.frameworks,competencies:c,search:f};d.render("tool_lp/link_course_competencies",i).done(function(b){a('[data-region="competencylinktree"]').replaceWith(b),this.initLinkCourseCompetencies()}.bind(this)).fail(b.exception)}.bind(this)).fail(b.exception)},initLinkCourseCompetencies:function(){new g("[data-enhance=linktree]",function(a){this.selectedCompetency=a.data("id")}.bind(this)),a('[data-action="chooseframework"]').change(function(a){return this.applyFilter(a)}.bind(this)),a('[data-region="filtercompetencies"] button').click(function(b){return a(b.target).attr("disabled","disabled"),this.applyFilter(b)}.bind(this)),a('[data-region="competencylinktree"] [data-action="cancel"]').click(function(b){a(b.target).attr("disabled","disabled"),b.preventDefault(),this.popup.close()}.bind(this)),a('[data-region="competencylinktree"] [data-action="add"]').click(function(e){e.preventDefault(),this.selectedCompetency&&(a(e.target).attr("disabled","disabled"),this.requests[0].args.competencyid=this.selectedCompetency,requests=c.call(this.requests),requests[1].done(function(c){d.render(this.pagerender,c).done(function(b,c){this.popup.close(),a('[data-region="'+this.pageregion+'"]').replaceWith(b),d.runTemplateJS(c),"undefined"!=typeof this.addCompetencyCallback&&this.addCompetencyCallback()}.bind(this)).fail(b.exception)}.bind(this)).fail(b.exception))}.bind(this))},addCompetencyChildren:function(a,b){var c;for(c=0;c<b.length;c++)b[c].parentid==a.id&&(a.haschildren=!0,b[c].children=[],b[c].haschildren=!1,a.children[a.children.length]=b[c],this.addCompetencyChildren(b[c],b))},searchCompetencies:function(){var b=a.Deferred(),d=a('[data-region="filtercompetencies"] input'),e="";d.length&&(e=d.val());var f=a('[data-action="chooseframework"]'),g=this.frameworks[0].id;f.length&&(g=f.val());var h=c.call([{methodname:"tool_lp_search_competencies",args:{searchtext:e,competencyframeworkid:g}}]);return h[0].done(function(a){var c,d=[];for(c=0;c<a.length;c++){var e=a[c];0===e.parentid&&(e.children=[],e.haschildren=0,d[d.length]=e,this.addCompetencyChildren(e,a))}b.resolve(d)}.bind(this)).fail(function(a){b.reject(a)}),b.promise()},openCompetencySelector:function(){this.searchCompetencies().done(function(a){var c=this.frameworks[0];c.selected=!0;var g={framework:c,frameworks:this.frameworks,competencies:a,search:""};d.render("tool_lp/link_course_competencies",g).done(function(a){f.get_string("linkcompetencies","tool_lp").done(function(b){this.popup=new e(b,a,function(){this.initLinkCourseCompetencies()}.bind(this))}.bind(this)).fail(b.exception)}.bind(this)).fail(b.exception)}.bind(this)).fail(b.exception)}}});